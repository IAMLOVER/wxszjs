<!--  -->
<template>
  <view>
    <poster id="poster" config="{{posterConfig}}" bind:success="onPosterSuccess" bind:fail="onPosterFail">
      <button @tap="onCreatePoster">海报</button>
  </poster>
  </view>
</template>

<script>
  import wepy from 'wepy';
  // import poster from '../../components/poster'
  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: "测试助力海报",
       usingComponents: {
        "poster": "../../components/miniprogram_dist/poster/index",
      }
    };

    data = {
      posterConfig:{
          width: 750,
          height: 1200,
          backgroundColor: '#F59562',
          debug: false,
           blocks: [
            {
                width:630,
                height:190,
                opacity:0.9,
                backgroundColor:'#fff',
                borderRadius:16,
                x:60,
                y:930,
                zIndex:5,
            }
        ],
        texts: [
            {
                x:214,
                y:100,
                text:[
                    {
                        text: '李瑞活',
                        fontSize: 32,
                        color: '#5F3118',
                        opacity: 1,
                        marginLeft: 0,
                        marginRight: 10,
                    }
                ]
            },
            {
                x: 214,
                y: 132,
                text: [
                    {
                        text: '我发现了超值好物，快来和我一起拼团吧',
                        fontSize: 36,
                        color: '#fff',
                        opacity: 1,
                        lineHeight:48,
                        lineNum:2,
                        width:475,
                    },
                ],
                baseLine: 'middle',
            },
        ],
        images: [
            {
                url: 'https://pictest.sqplus.cn/szjs/user/images/index/bg_talk02.png',
                width: 130,
                height: 130,
                y: 60,
                x: 60,
                borderRadius: 130,
            },
            {
                url:'https://pictest.sqplus.cn/szjs/user/images/index/bg_talk02.png',
                width: 750,
                height: 900,
                zIndex:2,
                x:0,
                y:200,
            },
            {
                url:'https://pictest.sqplus.cn/szjs/user/images/index/bg_talk02.png',
                width: 630,
                height: 650,
                zIndex:3,
                x:60,
                y:240,
            },
            {
                url:'https://pictest.sqplus.cn/sqj/1557830239349_VTzNuosP18.jpg',
                width:550,
                height:550,
                x:100,
                y:300,
                zIndex:4,
            }
        ],
    }
    };

    methods = {
    };  
        onPosterSuccess(e) {
        const { detail } = e;
        console.log(detail)
        wx.saveImageToPhotosAlbum({
            filePath:detail,
            success(res) { 
                console.log('成功了')
            },
            fail(err){
                console.log('呜呜')
                if (err.errMsg === "saveImageToPhotosAlbum:fail:auth denied" || err.errMsg === "saveImageToPhotosAlbum:fail auth deny") {
                    // 这边微信做过调整，必须要在按钮中触发，因此需要在弹框回调中进行调用
                    wx.showModal({
                      title: '提示',
                      content: '需要您授权保存相册',
                      showCancel: false,
                      success:res=>{
                        wx.openSetting({
                          success(settingdata) {
                            console.log("settingdata", settingdata)
                            if (settingdata.authSetting['scope.writePhotosAlbum']) {
                              wx.showModal({
                                title: '提示',
                                content: '获取权限成功,再次点击图片即可保存',
                                showCancel: false,
                              })
                            } else {
                              wx.showModal({
                                title: '提示',
                                content: '获取权限失败，将无法保存到相册哦~',
                                showCancel: false,
                              })
                            }
                          },
                          fail(failData) {
                            console.log("failData",failData)
                          },
                          complete(finishData) {
                            console.log("finishData", finishData)
                          }
                        })
                      }
                    })
                  }
                },
        })
    };
    onPosterFail(err) {
        console.error(err);
    };
     onCreatePoster() {
     }

    watch = {};

    computed = {};

    onLoad() { };

    onShow() { };
  }
</script>

<style lang='less'>
</style>